#!/bin/bash
# Handle keystrokes
# Sends Commands to activities

[ ! -r /etc/default/harmony ] && echo "Harmony Remote Daemon not installed, please run hrmy-setup."  && exit 1
. /etc/default/harmony
. $prefix/usr/lib/harmony/utils

#using harmonyd ?
if ! echo $PATH | grep -q "lib/harmony"; then
    export DISPLAY=:0
    export PATH=$prefix/bin:$prefix/usr/lib/harmony:$PATH
    export logfile
fi

usage(){
    throw_error "Usage: $(basename ${BASH_SOURCE[0]}) <KEY>"
}

[ -n "$1" ] || usage
[ -d $profile_root ] || exit 1
self=$(basename ${BASH_SOURCE[0]})
reserved="^(ON|OFF|REBOOT|SLEEP|SCREEN|ALARM|WWW)$"
keystore="$userspace/activity.key"
lockfile="$userspace/$self.lock"
lockset=0

[ -e $lockfile ] && exit 1

on_lock(){
    lockset=1
    cmd touch $lockfile
}

on_exit(){
    [ $lockset == 1 ] && cmd rm $lockfile
}

trigger lock
if [[ $1 =~ $reserved ]]; then
    if [ -r "$profile_root/main/reserved.keys" ]; then
        cmd pushd "$profile_root/main"
            bash "$profile_root/main/reserved.keys" $1
        cmd popd
    fi
    exit 0
fi

# Sends Notification to activity that a key has been pushed
printf "$1" > $keystore
pid=`activity.pid`
[ -n "$pid" ] && cmd kill -10 $pid

# Also sends key to passive activity
if [ -r "$profile_root/main/main.keys" ]; then
    cmd pushd "$profile_root/main"
        bash "$profile_root/main/main.keys" $1
    cmd popd
fi



