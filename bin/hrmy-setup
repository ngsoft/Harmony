#!/usr/bin/sudo /bin/bash

prefix=$(dirname "$(pushd $(dirname "${BASH_SOURCE[0]}") > /dev/null 2>&1 && pwd && popd > /dev/null 2>&1)")
logfile="/tmp/$(basename ${BASH_SOURCE[0]}).log"
description="Harmony Remote Daemon"
OVERRIDE=no

if [ ! -e $prefix/usr/lib/harmony/utils ]; then
    echo "$(basename ${BASH_SOURCE[0]}) cannot find libraries." >&2
    exit 1
fi
. $prefix/usr/lib/harmony/utils


#
# install_service <filename> <name>
#
install_service(){
    [ -n "$1" ] || [ -x "$1" ] ||  return 1
    name=$2
    [ -n "$name" ] || name=$(basename $1)
    [ -e "/etc/init.d/$name" ] && return 2
    cmd ln -s $1 /etc/init.d/$name
    cmd systemctl unmask $name
    cmd update-rc.d $name defaults
}


#
# remove_service <name>
#
remove_service(){
	[ -n "$1" ] || return 1
    [ -e "/etc/init.d/$1" ] || return 2
	cmd update-rc.d -f $1 remove
	cmd systemctl stop $1
	cmd rm /etc/init.d/$1
	disable_services $1
}

#
# Install dependencies required for the app to run
# also remove older versions
#
install_deps(){
    apt-get -y purge lirc lirc-x inputlirc flirc >> $logfile 2>&1
    apt-get -y --purge autoremove >> $logfile 2>&1
    cmd rm -fr /etc/lirc
    add-apt-repository -y -u ppa:leamas-alec/lirc-0.9.4 >> $logfile 2>&1
    echo "deb [trusted=yes] https://apt.fury.io/flirc/ /" > "/etc/apt/sources.list.d/flirc_fury.list"
    cmd apt-get update 
    apt-get -y install lirc lirc-x flirc xdotools >> $logfile 2>&1
    test -x /usr/sbin/lircd && return 0
    return 1
}


enable_services(){
    for act in unmask enable; do
        for service in $@; do
            systemctl $act $service >> $logfile 2>&1
            printf "Enabling $service service.\n"
        done
    done
    cmd systemctl daemon-reload >> $logfile 2>&1
	cmd systemctl reset-failed >> $logfile 2>&1
}

disable_services(){
    for act in disable mask stop; do
        for service in $@; do
            systemctl $act $service >> $logfile 2>&1
            printf "Disabling $service service.\n"
        done
    done
    cmd systemctl daemon-reload >> $logfile 2>&1
	cmd systemctl reset-failed >> $logfile 2>&1
}


create_cfg_file(){
    printf "#\n# File autogenerated by hrmy-setup\n#\n" > /etc/default/harmony
    echo "prefix=$prefix" >> /etc/default/harmony
    echo "device=$(get_device)" >> /etc/default/harmony
    echo "device_name=$(get_device_name)" >> /etc/default/harmony
}


if echo "$@" | grep "\-r" > /dev/null 2>&1; then
    printf "Removing Harmony Configuration\n"

    exit 0
fi


if [ -z "$(get_device)" ]; then
    throw_error "Cannot find Flirc device."
fi

if ask "Do you want to install $description ?" Y; then
	notify "Installing $description, please wait"
    echo "A log file is being created at $logfile";
    cmd rm $logfile
    touch $logfile
    echo "Installing dependencies, please wait ..."
    install_deps || throw_error "Cannot install dependencies"
    disable_services lircd-setup lircd-uinput lircdm irexec lircd
    echo "Installing service flirc"
    install_service $prefix/etc/init.d/flirc flirc
    echo "Installing configuration file /etc/default/harmony"
    create_cfg_file
    echo "All done, please reboot."
    notify "$description, installation complete."
fi
